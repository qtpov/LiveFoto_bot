from aiogram import types, F, Router
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder
from bot.keyboards.inline import go_profile_keyboard


router = Router()


class QuizGame(StatesGroup):
    waiting_for_answer = State()
    current_question = State()
    score = State()



QUESTIONS = [
    {
        "question": "–î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏?",
        "options": [
            "–ê) —á—Ç–æ –±—ã –±—ã–ª–æ –Ω–µ —Å–∫—É—á–Ω–æ",
            "–ë) —á—Ç–æ –±—ã –ø–æ–ª—É—á–∏—Ç—å –ó–ü",
            "–í) —á—Ç–æ –±—ã –∏–∑—É—á–∏—Ç—å —Ä–∞–±–æ—Ç—É –∏ —Å—Ç–∞—Ç—å —Å—É–ø–µ—Ä–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º",
            "–ì) –ß—Ç–æ –±—ã –ø—Ä–æ–∫–∞—á–∞—Ç—å —Å–≤–æ–µ–≥–æ –≥–µ—Ä–æ—è"
        ],
        "correct": 2  # –ò–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (0-based)
    },
    {
        "question": "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –∫–æ–≥–¥–∞ —É—Ç–æ–ø–∏–ª —Ñ–æ—Ç–∏–∫?",
        "options": [
            "–ê) —Å–æ–æ–±—â–∏—Ç—å –ê–¥–º–∏–Ω—É",
            "–ë) –≤—ã—Ç–∞—â–∏—Ç—å –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä",
            "–í) —Å–Ω—è—Ç—å –æ–±—ä–µ–∫—Ç–∏–≤",
            "–ì) –∑–∞—Å—É–Ω—É—Ç—å —Ñ–æ—Ç–∏–∫ –≤ —Ä–∏—Å"
        ],
        "correct": 1
    },
    {
        "question": "–ß–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ –ë–∞–∑–µ?",
        "options": [
            "–ê) —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤",
            "–ë) –¥–µ—Ç–µ–π",
            "–í) –¥–æ–º–∞—à–Ω–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö",
            "–ì) –º–∏–∫—Ä–æ—Å—Ö–µ–º"
        ],
        "correct": 2
    },
    {
        "question": "–ß—Ç–æ –∏–∑ –Ω–∏–∂–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏—è?",
        "options": [
            "–ê) –í—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å–º–µ—à–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞/–ª—é–¥–µ–π –≤ –∫–∞–¥—Ä–µ",
            "–ë) –í—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ —á—Ç–æ –±—ã –±—ã–ª–æ –Ω–µ—á–µ—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ª—é–¥–µ–π –≤ –∫–∞–¥—Ä–µ",
            "–í) –ü—Ä–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç –Ω—É–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–ª–∞–∑ —á–µ–ª–æ–≤–µ–∫–∞ –≤ –∫–∞–¥—Ä–µ",
            "–ì) –ü—Ä–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç –Ω—É–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å —Ç–∞–∫ —á—Ç–æ–±—ã –≥–ª–∞–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞ –±—ã–ª–∏ –ø–æ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–∞–¥—Ä–∞"
        ],
        "correct": 2
    },
    {
        "question": "–ß—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π –∫–æ–º–ø–∞–Ω–∏–∏?",
        "options": [
            "–ê) –º–∞–≥–Ω–∏—Ç—ã",
            "–ë) 3D —Å—Ç–∏–∫–µ—Ä—ã",
            "–í) —Ñ–æ—Ç–æ –Ω–∞ —Ñ—É—Ç–±–æ–ª–∫–µ",
            "–ì) —Ñ–æ—Ç–æ—Ä–∞–º–∫–∏"
        ],
        "correct": 2
    },
    {
        "question": "–ß—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —ç—Ç–∞–ø–æ–º –ø—Ä–æ–¥–∞–∂?",
        "options": [
            "–ê) –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞",
            "–ë) —É–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É, –≥–¥–µ —Ç—É–∞–ª–µ—Ç",
            "–í) –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–ª–∏–µ–Ω—Ç–∞",
            "–ì) –û–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ —Ñ–æ—Ç–æ–∑–æ–Ω–µ"
        ],
        "correct": 1
    },
    {
        "question": "–ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–¥–∞–∂–µ–π?",
        "options": [
            "–ê) –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∫—É–ø–∏–ª –≤—Å—é –ø—Ä–æ–¥—É–∫—Ü–∏—é —Å–æ —Å–∫–∏–¥–∫–æ–π –∏ —É—à–µ–ª –¥–æ–≤–æ–ª—å–Ω—ã–π",
            "–ë) –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∫—É–ø–∏–ª —Å–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π —Ç–æ–≤–∞—Ä",
            "–í) –∫–æ–≥–¥–∞ –º–∞–º–∞ –∏–∑ –∂–∞–ª–æ—Å—Ç–∏ –∫—É–ø–∏–ª–∞ –æ–¥–∏–Ω –º–∞–≥–Ω–∏—Ç–∏–∫",
            "–ì) –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∫—É–ø–∏–ª –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –ø–æ –ø–∞–∫–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –∏ —É—à—ë–ª –¥–æ–≤–æ–ª—å–Ω—ã–π"
        ],
        "correct": 3
    },
    {
        "question": "–ß—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º –ø—Ä–æ–¥–∞–∂?",
        "options": [
            "–ê) –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞",
            "–ë) –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤",
            "–í) –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤",
            "–ì) —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫"
        ],
        "correct": 0
    },
    {
        "question": "–ß—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç–æ–º —Ñ–æ—Ä–º–µ–Ω–Ω–æ–π –æ–¥–µ–∂–¥—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –Ω–∞ –ª–æ–∫–∞—Ü–∏–∏?",
        "options": [
            "–ê) –§—É—Ç–±–æ–ª–∫–∞",
            "–ë) –ü–æ–≤—è–∑–∫–∞ –Ω–∞ –≤–æ–ª–æ—Å—ã",
            "–í) –ñ–∏–ª–µ—Ç–∫–∞",
            "–ì) –®–æ—Ä—Ç—ã"
        ],
        "correct": 2
    }
]


@router.callback_query(F.data.startswith("quiz_answer_"))
async def handle_quiz_answer(callback: CallbackQuery, state: FSMContext):
    await process_quiz_answer(callback, state)


async def start_quiz_game(callback: CallbackQuery, state: FSMContext):
    await state.set_state(QuizGame.waiting_for_answer)
    await state.update_data(current_question=0, score=0)
    await ask_question(callback.message, state)


async def ask_question(message: types.Message, state: FSMContext):
    data = await state.get_data()
    question_index = data.get("current_question", 0)

    if question_index >= len(QUESTIONS):
        await finish_quiz(message, state)
        return

    question_data = QUESTIONS[question_index]

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
    question_text = f"–í–æ–ø—Ä–æ—Å {question_index + 1}/{len(QUESTIONS)}:\n\n{question_data['question']}\n\n"
    for option in question_data["options"]:
        question_text += f"{option}\n"

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –±—É–∫–≤–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–ê, –ë, –í, –ì)
    builder = InlineKeyboardBuilder()
    for i in range(len(question_data["options"])):
        letter = chr(1040 + i)  # 1040 - –∫–æ–¥ –±—É–∫–≤—ã '–ê' –≤ Unicode
        builder.add(types.InlineKeyboardButton(
            text=letter,
            callback_data=f"quiz_answer_{i}"
        ))
    builder.adjust(4)  # –†–∞–∑–º–µ—â–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–∏–Ω —Ä—è–¥

    await message.edit_text(
        question_text,
        reply_markup=builder.as_markup()
    )


async def process_quiz_answer(callback: CallbackQuery, state: FSMContext):
    answer_index = int(callback.data.split("_")[-1])
    data = await state.get_data()
    question_index = data.get("current_question", 0)
    score = data.get("score", 0)

    if answer_index == QUESTIONS[question_index]["correct"]:
        score += 1
        await callback.answer("–ü—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ")
    else:
        correct_index = QUESTIONS[question_index]["correct"]
        correct_letter = chr(1040 + correct_index)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–Ω–¥–µ–∫—Å –≤ –±—É–∫–≤—É
        await callback.answer(f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_letter}")

    await state.update_data(
        current_question=question_index + 1,
        score=score
    )
    await ask_question(callback.message, state)


async def finish_quiz(message: types.Message, state: FSMContext):
    data = await state.get_data()
    score = data.get("score", 0)
    total = len(QUESTIONS)
    percentage = int(score / total * 100)

    # –†–µ–∞–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    reactions = {
        1: "–û—É, 1 –∏–∑ 9 ‚Äî –∫–∞–∫ –ø–µ—Ä–≤—ã–π –ª–∞–π–∫: –Ω–µ–º–Ω–æ–≥–æ –≥—Ä—É—Å—Ç–Ω–æ, –Ω–æ –Ω–∞–¥–µ–∂–¥–∞ –µ—Å—Ç—å! üòÖ\n–ù–µ –ø–∞—Ä—å—Å—è, –ø–µ—Ä–µ—Å–¥–∞–≤–∞–π, –∏ –∑–∞—Ñ–∏–≥–∞—á–∏–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!",
        2: "–î–≤–∞ ‚Äî —É–∂–µ –Ω–µ –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª, –Ω–æ –∏ –Ω–µ —É–ª—å—Ç—Ä–∞-–±–æ–º–±–∞. üòú\n–î–∞–≤–∞–π, –ø–æ–¥—Ç—è–≥–∏–≤–∞–π –∑–Ω–∞–Ω–∏—è, –∏ –±—É–¥–µ—Ç –æ–≥–æ–Ω—å!",
        3: "–¢—Ä–∏ ‚Äî –∫–∞–∫ —Ç—Ä–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –Ω–∞ —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç: –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ —Å–≤–æ–π —Ñ–∞–Ω-–∫–ª—É–±! üòé\n–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞—á–∞—Ç—å, –±—É–¥–µ—Ç –ª–∞–π–∫–∞—Ç—å –≤—Å—è –ª–µ–Ω—Ç–∞!",
        4: "–ß–µ—Ç—ã—Ä–µ ‚Äî –∫–∞–∫ —á–µ—Ç–≤–µ—Ä–∫–∞ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —à–∫–æ–ª–µ: —Å–æ–π–¥–µ—Ç, –Ω–æ –º–æ–≥–ª–æ –±—ã –±—ã—Ç—å –∏ –∫—Ä—É—á–µ. üìö\n–ü—Ä–æ–∫–∞—á–∞–π—Å—è, –∏ —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ –Ω–∞ ‚Äú5+‚Äù!",
        5: "–ü—è—Ç—å ‚Äî —É–∂–µ –ø–æ—á—Ç–∏ –ø–æ–ª–æ–≤–∏–Ω–∞! –¢—ã –∫–∞–∫ –º–µ–º, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∞–ª–∏ –ª–∞–π–∫–∞—Ç—å. üî•\n–î–µ—Ä–∂–∏ —Ç–µ–º–ø, —Å–∫–æ—Ä–æ –±—É–¥–µ—à—å —Ç–æ–ø-–∞–∫–∫–∞—É–Ω—Ç–æ–º!",
        6: "–®–µ—Å—Ç—å ‚Äî –ø–æ—á—Ç–∏ –ø—Ä–æ—Ñ–∏, –∫–∞–∫ —Ç–∏–∫—Ç–æ–∫–µ—Ä —Å 10–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. üéâ\n–ß—É—Ç—å-—á—É—Ç—å —É—Å–∏–ª–∏–π ‚Äî –∏ –±—É–¥–µ—à—å –≤ —Ç—Ä–µ–Ω–¥–∞—Ö!",
        7: "–°–µ–º—å ‚Äî –æ–≥–æ–Ω—å! –£–∂–µ –ø–æ—á—Ç–∏ –∫–æ—Ä–æ–ª—å (–∏–ª–∏ –∫–æ—Ä–æ–ª–µ–≤–∞) –ª–∞–π–∫–æ–≤. üëë\n–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ ‚Äî —Ñ–∞–Ω–∞—Ç—ã —Ä—è–¥–æ–º!",
        8: "–í–æ—Å–µ–º—å ‚Äî –ø–æ—á—Ç–∏ –±–µ–∑—É–ø—Ä–µ—á–Ω–æ! –¢—ã –∫–∞–∫ —Ç–æ—Ç —á—É–≤–∞–∫, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Å–µ–≥–¥–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä. ‚ú®\n–ü–æ—á—Ç–∏ —Ö–µ–¥–ª–∞–π–Ω–µ—Ä –Ω–∞—à–µ–≥–æ —Ñ–æ—Ç–æ–∫–ª—É–±–∞!",
        9: "–î–µ–≤—è—Ç—å –∏–∑ –¥–µ–≤—è—Ç–∏ ‚Äî –ë–û–°–°! –¢—ã –∫–∞–∫ –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. üèÜüî•\n–í—Å–µ –æ—Ç–≤–µ—Ç—ã ‚Äî –Ω–∞ –º–∞–∑–∏, —É–≤–∞–∂—É—Ö–∞!"
    }

    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ä–µ–∞–∫—Ü–∏—é
    reaction = reactions.get(score, "–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!")

    await message.edit_text(
        f"üèÜ –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/{total}\n"
        f"üìà –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {percentage}%\n\n"
        f"{reaction}",
        reply_markup=go_profile_keyboard()
    )
    await state.clear()